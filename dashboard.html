<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gateways Proxy</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="dashboard.html">Freeway Cards</a>
            </div>
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav-menu" id="nav-menu">
                <a href="dashboard.html" class="active">Dashboard</a>
                <a href="cards.html">Cards</a>
                <a href="wallet.html">Wallet</a>
                <a href="profile.html">Profile</a>
                <div class="user-menu">
                    <div class="user-dropdown">
                        <button class="user-button" onclick="toggleUserMenu()">
                            <span id="user-name">User</span>
                            <span class="dropdown-arrow">â–¼</span>
                        </button>
                        <div id="user-dropdown-menu" class="dropdown-menu hidden">
                            <a href="profile.html">Profile Settings</a>
                            <a href="wallet.html">Wallet</a>
                            <a href="support.html">Support</a>
                            <hr>
                            <button onclick="logout()" class="logout-btn">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-header">
            <h1>Welcome back, <span id="welcome-name">User</span></h1>
            <p>Here's your account overview</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Active Cards</h3>
                <div class="stat-number" id="active-cards">0</div>
                <div class="stat-change positive">+2 this week</div>
            </div>
            <div class="stat-card">
                <h3>Wallet Balance</h3>
                <div class="stat-number" id="wallet-balance">$0.00</div>
                <div class="stat-change">Available funds</div>
            </div>
            <div class="stat-card">
                <h3>This Month</h3>
                <div class="stat-number" id="monthly-spending">$0</div>
                <div class="stat-change positive">Total spending</div>
            </div>
            <div class="stat-card">
                <h3>Account Status</h3>
                <div class="stat-number" id="account-status">Active</div>
                <div class="stat-change">Next billing: Dec 15</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3>My Cards</h3>
                <div id="cards-overview" class="cards-overview">
                    <!-- Cards will be loaded here -->
                </div>
                <div class="card-actions">
                    <a href="cards.html" class="btn btn-primary">View All Cards</a>
                    <button onclick="openCreateCardModal()" class="btn btn-secondary">Create New</button>
                </div>
            </div>
            
            <div class="dashboard-card">
                <h3>Spending Analytics</h3>
                <canvas id="spendingChart"></canvas>
            </div>
            
            <div class="dashboard-card">
                <h3>Recent Transactions</h3>
                <div id="recent-transactions" class="transactions-feed">
                    <!-- Transactions will be loaded here -->
                </div>
                <a href="wallet.html" class="view-all-link">View all transactions â†’</a>
            </div>
            
            <div class="dashboard-card">
                <h3>Quick Actions</h3>
                <div class="quick-actions">
                    <button onclick="openCreateCardModal()" class="action-btn">
                        <div class="action-icon">ðŸ’³</div>
                        <div class="action-content">
                            <h4>Create Card</h4>
                            <p>Generate new virtual card</p>
                        </div>
                    </button>
                    <a href="wallet.html" class="action-btn">
                        <div class="action-icon">ðŸ’°</div>
                        <div class="action-content">
                            <h4>Fund Wallet</h4>
                            <p>Add money to your account</p>
                        </div>
                    </a>
                    <a href="support.html" class="action-btn">
                        <div class="action-icon">ðŸŽ§</div>
                        <div class="action-content">
                            <h4>Get Support</h4>
                            <p>Contact our team</p>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check authentication
        function checkAuth() {
            const currentUser = localStorage.getItem('currentUser');
            const authToken = localStorage.getItem('authToken');
            
            if (!currentUser || !authToken) {
                window.location.href = 'login.html';
                return null;
            }
            
            return JSON.parse(currentUser);
        }

        // Initialize dashboard
        function initDashboard() {
            const user = checkAuth();
            if (!user) return;
            
            // Update user info
            document.getElementById('user-name').textContent = user.name;
            document.getElementById('welcome-name').textContent = user.name;
            
            // Load user data
            loadUserStats();
            createUsageChart();
        }

        // Load user statistics
        function loadUserStats() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const cards = JSON.parse(localStorage.getItem('userCards') || '[]');
            const wallets = JSON.parse(localStorage.getItem('wallets') || '{}');
            
            const userCards = cards.filter(c => c.userId === currentUser.email);
            const activeCards = userCards.filter(c => c.status === 'active');
            const userWallet = wallets[currentUser.email] || { balance: 0, transactions: [] };
            
            // Calculate monthly spending from wallet transactions
            const monthlySpending = userWallet.transactions
                .filter(t => {
                    const transactionDate = new Date(t.date);
                    const now = new Date();
                    return transactionDate.getMonth() === now.getMonth() && 
                           transactionDate.getFullYear() === now.getFullYear() &&
                           t.type === 'debit';
                })
                .reduce((sum, t) => sum + t.amount, 0);
            
            document.getElementById('active-cards').textContent = activeCards.length;
            document.getElementById('wallet-balance').textContent = `$${userWallet.balance.toFixed(2)}`;
            document.getElementById('monthly-spending').textContent = `$${monthlySpending.toFixed(2)}`;
        }

        // Load cards overview
        function loadCardsOverview() {
            const cards = JSON.parse(localStorage.getItem('userCards') || '[]');
            const userCards = cards.filter(c => c.userId === JSON.parse(localStorage.getItem('currentUser')).email);
            const cardsOverview = document.getElementById('cards-overview');
            
            if (userCards.length === 0) {
                cardsOverview.innerHTML = '<div class="empty-cards"><p>No cards yet</p><button onclick="openCreateCardModal()" class="btn btn-primary">Create Your First Card</button></div>';
                return;
            }
            
            cardsOverview.innerHTML = userCards.slice(0, 3).map(card => `
                <div class="card-mini ${card.type} ${card.status}">
                    <div class="card-mini-brand">${card.type.toUpperCase()}</div>
                    <div class="card-mini-name">${card.name}</div>
                    <div class="card-mini-balance">$${card.balance.toFixed(2)}</div>
                    <div class="card-mini-status ${card.status}">${card.status}</div>
                </div>
            `).join('');
        }
        
        // Load recent transactions
        function loadRecentTransactions() {
            const wallets = JSON.parse(localStorage.getItem('wallets') || '{}');
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const userWallet = wallets[currentUser.email];
            const transactionsFeed = document.getElementById('recent-transactions');
            
            if (!userWallet || userWallet.transactions.length === 0) {
                transactionsFeed.innerHTML = '<div class="empty-transactions"><p>No transactions yet</p></div>';
                return;
            }
            
            const recentTransactions = userWallet.transactions.slice(0, 5);
            transactionsFeed.innerHTML = recentTransactions.map(transaction => `
                <div class="transaction-mini">
                    <div class="transaction-mini-info">
                        <div class="transaction-mini-desc">${transaction.description}</div>
                        <div class="transaction-mini-date">${new Date(transaction.date).toLocaleDateString()}</div>
                    </div>
                    <div class="transaction-mini-amount ${transaction.type}">
                        ${transaction.type === 'credit' ? '+' : '-'}$${transaction.amount.toFixed(2)}
                    </div>
                </div>
            `).join('');
        }
        
        // Create spending chart
        function createSpendingChart() {
            const ctx = document.getElementById('spendingChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Cards', 'Transfers', 'Fees'],
                    datasets: [{
                        data: [65, 30, 5],
                        backgroundColor: ['#2563eb', '#059669', '#dc2626']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // User menu toggle
        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown-menu');
            dropdown.classList.toggle('hidden');
        }
        
        // Mobile menu toggle
        function toggleMobileMenu() {
            const navMenu = document.getElementById('nav-menu');
            const toggle = document.querySelector('.mobile-menu-toggle');
            navMenu.classList.toggle('mobile-active');
            toggle.classList.toggle('active');
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.querySelector('.user-dropdown');
            const dropdown = document.getElementById('user-dropdown-menu');
            
            if (!userMenu.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });
        
        // Logout function
        function logout() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('authToken');
            window.location.href = 'index.html';
        }

        // Open create card modal
        function openCreateCardModal() {
            window.location.href = 'cards.html';
        }
        
        // Initialize dashboard
        function initDashboard() {
            const user = checkAuth();
            if (!user) return;
            
            // Update user info
            document.getElementById('user-name').textContent = user.name;
            document.getElementById('welcome-name').textContent = user.name;
            
            // Load all dashboard data
            loadUserStats();
            loadCardsOverview();
            loadRecentTransactions();
            createSpendingChart();
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>